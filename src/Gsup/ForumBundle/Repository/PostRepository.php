<?php

namespace Gsup\ForumBundle\Repository;

use Doctrine\ODM\MongoDB\DocumentRepository;

/**
 * PostRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PostRepository extends DocumentRepository
{
    /**
     * Get list query.
     *
     * @return \Doctrine\MongoDB\Query\Query
     */
    public function getListQuery()
    {
        return $this->createQueryBuilder()
            ->field('user')->exists(true)
            ->field('is_active')->equals(true)
            ->sort('created_at', 'DESC')
            ->getQuery();
    }

    /**
     * Find active post by id
     *
     * @param $id
     * @return array|null|object
     */
    public function findActiveById($id)
    {
        return $this->createQueryBuilder()
            ->field('_id')->equals(new \MongoId($id))
            ->field('user')->exists(true)
            ->field('is_active')->equals(true)
            ->getQuery()
            ->getSingleResult();
    }

    /**
     * Find active post document.
     *
     * @param $slug
     * @return mixed
     */
    public function findActiveBySlug($slug)
    {
        return $this->createQueryBuilder()
            ->field('slug')->equals($slug)
            ->field('user')->exists(true)
            ->field('is_active')->equals(true)
            ->getQuery()
            ->getSingleResult();
    }

    /**
     * @param $user
     * @return array|null|object
     */
    public function findAllInActiveByUser($user)
    {
        return $this->createQueryBuilder()
//            ->field('user.$id')->equals(new \MongoId($userId))
            ->field('user')->references($user)
            ->field('is_active')->equals(false)
            ->getQuery()
            ->execute();
    }

    /**
     * Find active post with matching reply id.
     *
     * @param $replyId
     * @return array|null|object
     */
    public function findActiveByReplyId($replyId)
    {
        return $this->createQueryBuilder()
            ->field('reply._id')->equals(new \MongoId($replyId))
            ->field('is_active')->equals(true)
            ->getQuery()
            ->getSingleResult()
            ;
    }
}